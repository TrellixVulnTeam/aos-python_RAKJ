{
  "label": "ECMP Imbalance (spine to superspine interfaces)",
  "description": "The probe calculates ECMP imbalance on spine to superspine ports",
  "processors": [
    {
      "inputs": {},
      "type": "if_counter",
      "name": "spine fabric interface traffic",
      "outputs": {
        "out": "spine_fabric_int_traffic"
      },
      "properties": {
        "graph_query": "node(\"system\", name=\"system\", deploy_mode=\"deploy\", role=\"spine\").out(\"hosted_interfaces\").node(\"interface\", name=\"iface\", if_name=not_none()).out(\"link\").node(\"link\", link_type=\"ethernet\").in_(\"link\").node(\"interface\").in_(\"hosted_interfaces\").node(\"system\", role=\"superspine\", deploy_mode=\"deploy\")",
        "label": "system.label",
        "interface": "iface.if_name",
        "system_id": "system.system_id",
        "enable_streaming": false,
        "counter_type": "tx_bps"
      }
    },
    {
      "inputs": {
        "in": "spine_fabric_int_traffic"
      },
      "type": "accumulate",
      "name": "spine fabric interface history",
      "outputs": {
        "out": "spine_fab_int_time_series"
      },
      "properties": {
        "enable_streaming": false,
        "max_samples": 1024,
        "graph_query": [],
        "total_duration": 300
      }
    },
    {
      "inputs": {
        "in": "spine_fabric_int_traffic"
      },
      "type": "periodic_average",
      "name": "spine fabric interface traffic average",
      "outputs": {
        "out": "spine_fab_int_tx_avg"
      },
      "properties": {
        "enable_streaming": false,
        "period": 30,
        "graph_query": []
      }
    },
    {
      "inputs": {
        "in": "spine_fab_int_tx_avg"
      },
      "type": "std_dev",
      "name": "spine fabric interface std-dev",
      "outputs": {
        "out": "spine_fab_int_std_dev"
      },
      "properties": {
        "enable_streaming": false,
        "group_by": [
          "system_id",
          "label"
        ],
        "ddof": 0
      }
    },
    {
      "inputs": {
        "in": "spine_fab_int_std_dev"
      },
      "type": "range_check",
      "name": "live ecmp imbalance",
      "outputs": {
        "out": "live_ecmp_imbalance"
      },
      "properties": {
        "enable_streaming": false,
        "property": "value",
        "range": {
          "min": 21
        },
        "raise_anomaly": false,
        "graph_query": []
      }
    },
    {
      "inputs": {
        "in": "live_ecmp_imbalance"
      },
      "type": "time_in_state_check",
      "name": "sustained ecmp imbalance",
      "outputs": {
        "out": "system_tx_imbalance"
      },
      "properties": {
        "enable_streaming": false,
        "time_window": 300,
        "state_range": {
          "\"true\"": [
            {
              "min": 131
            }
          ]
        },
        "raise_anomaly": true,
        "graph_query": []
      }
    },
    {
      "inputs": {
        "in": "system_tx_imbalance"
      },
      "type": "accumulate",
      "name": "anomaly accumulate",
      "outputs": {
        "out": "anomaly_accumulate"
      },
      "properties": {
        "enable_streaming": false,
        "max_samples": 1024,
        "graph_query": [],
        "total_duration": 0
      }
    },
    {
      "inputs": {
        "in": "system_tx_imbalance"
      },
      "type": "match_count",
      "name": "systems imbalanced count",
      "outputs": {
        "out": "system_imbalance_count"
      },
      "properties": {
        "enable_streaming": false,
        "group_by": [],
        "reference_state": "true"
      }
    },
    {
      "inputs": {
        "in": "system_imbalance_count"
      },
      "type": "range_check",
      "name": "imbalanced system count out of range",
      "outputs": {
        "out": "imbalanced_system_count_out_of_range"
      },
      "properties": {
        "enable_streaming": false,
        "property": "value",
        "range": {
          "min": 2
        },
        "raise_anomaly": true,
        "graph_query": []
      }
    },
    {
      "inputs": {
        "in": "imbalanced_system_count_out_of_range"
      },
      "type": "accumulate",
      "name": "imbalanced system count anomaly history",
      "outputs": {
        "out": "imbalanced_system_count_history"
      },
      "properties": {
        "enable_streaming": false,
        "max_samples": 1024,
        "graph_query": [],
        "total_duration": 0
      }
    }
  ],
  "stages": [
    {
      "name": "spine_fabric_int_traffic",
      "units": "bps"
    },
    {
      "name": "spine_fab_int_tx_avg",
      "units": "bps"
    },
    {
      "name": "spine_fab_int_time_series",
      "units": "bps"
    },
    {
      "name": "spine_fab_int_std_dev",
      "units": "bps"
    }
  ]
}