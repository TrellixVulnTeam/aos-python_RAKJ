{"label": "Fault_Tolerance  - Link fault tolerance in server LAGs", "description": "Find out if failure of one link in a server LAG is going to be tolerated. Monitors total traffic in each LAG against total available capacity of the bond, with one link failure. Raise anomaly for racks with more than 50% of such overused bonds, sustained for certain duration", "processors": [{"inputs": {}, "type": "if_counter", "name": "Leaf interface rx", "outputs": {"out": "Leaf interface rx"}, "properties": {"graph_query": "match(node('system', name='server', role='l2_server').out('hosted_interfaces').node('interface', name='server_bond', if_type='port_channel').out('composed_of').node('interface', name='server_intf').out('link').node('link', name='link').in_('link').node('interface', name='leaf_intf').in_('hosted_interfaces').node('system', name='leaf', role='leaf', deploy_mode='deploy'),node(name='leaf').out('part_of_rack').node('rack', name='rack'))", "server_bond": "server_bond.description", "server_bond_id": "server_bond.id", "interface": "leaf_intf.if_name", "system_id": "leaf.system_id", "enable_streaming": false, "server": "server.hostname or server.label", "speed": "link.speed", "rack": "rack.label", "counter_type": "rx_bps"}}, {"inputs": {"in": "Leaf interface rx"}, "type": "periodic_average", "name": "Average leaf interface rx", "outputs": {"out": "Average leaf interface rx"}, "properties": {"enable_streaming": false, "period": 60, "graph_query": []}}, {"inputs": {"in": "Average leaf interface rx"}, "type": "sum", "name": "Total traffic per server bond", "outputs": {"out": "Total traffic per server bond"}, "properties": {"enable_streaming": false, "group_by": ["server", "server_bond", "server_bond_id", "speed", "rack"]}}, {"inputs": {"in": "Total traffic per server bond"}, "type": "accumulate", "name": "History of total traffic per server bond", "outputs": {"out": "History of total traffic per server bond"}, "properties": {"enable_streaming": false, "max_samples": 1024, "graph_query": [], "total_duration": 0}}, {"inputs": {"in": "History of total traffic per server bond"}, "type": "range_check", "name": "Check tolerance threshold", "outputs": {"out": "Server bonds exceeding tolerance"}, "properties": {"enable_streaming": false, "property": "value", "range": {"min": "(len([qr for qr in query_result if qr['server_bond'].id == context.server_bond_id])-1) * functions.speed_to_bits(context.speed)"}, "raise_anomaly": false, "graph_query": ["match(node('system', name='server', role='l2_server').out('hosted_interfaces').node('interface', name='server_bond', if_type='port_channel').out('composed_of').node('interface', name='server_intf').out('link').node('link', name='link').in_('link').node('interface', name='leaf_intf').in_('hosted_interfaces').node('system', name='leaf', role='leaf', deploy_mode='deploy'),node(name='leaf').out('part_of_rack').node('rack', name='rack'))"]}}, {"inputs": {"in": "Server bonds exceeding tolerance"}, "type": "match_perc", "name": "Percent of bonds per rack", "outputs": {"out": "Percent of bonds per rack"}, "properties": {"enable_streaming": false, "group_by": ["rack"], "reference_state": "true"}}, {"inputs": {"in": "Percent of bonds per rack"}, "type": "accumulate", "name": "History of percent of bonds per rack", "outputs": {"out": "History of percent of bonds per rack"}, "properties": {"enable_streaming": false, "max_samples": 1024, "graph_query": [], "total_duration": 0}}, {"inputs": {"in": "History of percent of bonds per rack"}, "type": "range_check", "name": "Check per rack bond percent threshold", "outputs": {"out": "Racks with high percent of bonds"}, "properties": {"enable_streaming": false, "property": "value", "range": {"min": 50}, "raise_anomaly": false, "graph_query": []}}, {"inputs": {"in": "Racks with high percent of bonds"}, "type": "time_in_state_check", "name": "Affected racks anomaly", "outputs": {"out": "Racks with persistent high percent of bonds"}, "properties": {"enable_streaming": false, "time_window": 600, "state_range": {"\"true\"": [{"min": 300}]}, "raise_anomaly": true, "graph_query": []}}], "stages": [{"name": "Racks with persistent high percent of bonds", "description": "Racks with persistently high percentage of server bonds, with total bandwidth exceeding available capacity, in presence of one link failure"}, {"name": "History of percent of bonds per rack", "description": "History of percentage of server bonds per rack, with total bandwidth exceeding available capacity, in presence of one link failure"}, {"name": "Racks with high percent of bonds", "description": "Racks with high percentage of server bonds, with total bandwidth exceeding available capacity, in presence of one link failure"}, {"name": "Leaf interface rx", "description": "Leaf interfaces facing server interfaces that are part of a bond. Value is ingress bits per second", "units": "bps"}, {"name": "Percent of bonds per rack", "description": "Percentage of server bonds per rack, with total bandwidth exceeding available capacity, in presence of one link failure"}, {"name": "Server bonds exceeding tolerance", "description": "Server bonds with total bandwidth exceeding available capacity, in presence of one link failure"}], "disabled": true}