{"label": "Virtual_Infra - Hypervisor and Fabric Vlan config mismatch", "processors": [{"inputs": {}, "type": "generic_graph_collector", "name": "Fabric configured VLAN configs", "outputs": {"out": "Fabric VLAN configs"}, "properties": {"graph_query": "match(node('system', name='server', role='l2_server').out('hosted_interfaces').node('interface', name='server_intf').out('link').node('link').in_('link').node('interface', name='leaf_or_rg_intf').in_('hosted_interfaces').node(name='leaf_or_rg').ensure_different('server_intf', 'leaf_or_rg_intf'),node(name='server_intf').out('hosted_vn_endpoints').node('vn_endpoint', name='vn_endpoint').in_('member_endpoints').node('virtual_network').out('instantiated_by').node('vn_instance', name='vn_instance'),node(name='server').in_('is_realized_by').node('hypervisor', name='hv'),optional(node(name='leaf_or_rg_intf').out('composed_of').node('interface', if_type='port_channel', name='child_leaf_po'))).having(node(name='vn_instance').in_('hosted_vn_instances').node('system', system_id=not_none(), deploy_mode='deploy').out('hosted_interfaces').node('interface').out('link').node('link').in_('link').node('interface').in_('hosted_interfaces').node(name='server'), at_least=1, names=['vn_instance', 'server']).distinct(['server', 'vn_endpoint'])", "data_type": "ns", "connected_to": "str(leaf_or_rg.label if leaf_or_rg.type == 'redundancy_group' else leaf_or_rg.hostname)", "hypervisor": "str(hv.label)", "vlan": "int(0 if vn_endpoint.tag_type == 'untagged'else vn_instance.vlan_id)", "value": "1", "server": "str(server.label)", "interface": "str(server_intf.id)", "fabric_interface": "str(child_leaf_po.if_name if child_leaf_po else leaf_or_rg_intf.if_name)", "traffic": "str('untagged' if vn_endpoint.tag_type == 'untagged'else 'tagged')", "enable_streaming": false}}, {"inputs": {}, "type": "generic_graph_collector", "name": "Hypervisor expected VLAN configs", "outputs": {"out": "Hypervisor VLAN configs"}, "properties": {"data_type": "ns", "graph_query": ["match(node('system', name='server', system_type='server').in_('is_realized_by').node('hypervisor', name='hv').out('has').node('pnic', name='hv_nic').out('carries').node('vnet', vn_type='vlan', name='vnet'),node(name='hv_nic').out('is_realized_by').node('interface').in_('composed_of').node('interface', name='server_intf').out('link').node('link').in_('link').node('interface', name='leaf_or_rg_intf').in_('hosted_interfaces').node(name='leaf_or_rg').ensure_different('server_intf', 'leaf_or_rg_intf'),optional(node(name='leaf_or_rg_intf').out('composed_of').node('interface', if_type='port_channel', name='child_leaf_po'))).distinct(['server', 'server_intf', 'vnet'])", "match(node('system', name='server', system_type='server').in_('is_realized_by').node('hypervisor', name='hv').out('has').node('pnic', name='hv_nic').out('carries').node('vnet', vn_type='vlan', name='vnet'),node(name='hv_nic').out('is_realized_by').node('interface', name='server_intf').out('link').node('link').in_('link').node('interface', name='leaf_or_rg_intf').in_('hosted_interfaces').node(name='leaf_or_rg').ensure_different('server_intf', 'leaf_or_rg_intf').having(node(name='server_intf').in_('composed_of').node('interface'), at_most=0),optional(node(name='leaf_or_rg_intf').out('composed_of').node('interface', if_type='port_channel', name='child_leaf_po')))"], "connected_to": "str(leaf_or_rg.label if leaf_or_rg.type == 'redundancy_group' else leaf_or_rg.hostname)", "hypervisor": "str(hv.label)", "vlan": "int(vnet.vlan)", "value": "1", "server": "str(server.label)", "interface": "str(server_intf.id)", "fabric_interface": "str(child_leaf_po.if_name if child_leaf_po else leaf_or_rg_intf.if_name)", "traffic": "str('tagged' if vnet.vlan != 0 else 'untagged')", "enable_streaming": false, "network_label": "str(vnet.label)"}}, {"inputs": {"in": "Hypervisor VLAN configs"}, "type": "set_count", "name": "Hypervisor unique VLAN configs", "outputs": {"out": "Hypervisor unique VLAN configs"}, "properties": {"enable_streaming": false, "group_by": ["server", "vlan", "interface", "traffic", "hypervisor", "connected_to", "fabric_interface"]}}, {"inputs": {"A": "Hypervisor unique VLAN configs", "B": "Fabric VLAN configs"}, "type": "set_comparison", "name": "Differences between Hypervisor and Fabric", "outputs": {"A & B": "Common in Fabric and Hypervisor", "B - A": "Fabric Only", "A - B": "Hypervisor Only"}, "properties": {"enable_streaming": false, "significant_keys": ["server", "vlan", "interface", "traffic", "hypervisor", "connected_to", "fabric_interface"]}}, {"inputs": {"in": "Hypervisor Only"}, "type": "accumulate", "name": "Fabric missing VLAN configs accumulator", "outputs": {"out": "Hypervisor Only TimeSeries"}, "properties": {"enable_streaming": false, "max_samples": 1024, "graph_query": [], "total_duration": 0}}, {"inputs": {"in": "Fabric Only"}, "type": "accumulate", "name": "Hypervisor missing VLAN configs accumulator", "outputs": {"out": "Fabric Only TimeSeries"}, "properties": {"enable_streaming": false, "max_samples": 1024, "graph_query": [], "total_duration": 0}}, {"inputs": {"in": "Hypervisor Only TimeSeries"}, "type": "range_check", "name": "Check for Fabric missing VLAN configs", "outputs": {"out": "Fabric missing VLAN configs anomaly"}, "properties": {"graph_query": [], "anomaly_retention_size": 1073741824, "anomaly_retention_duration": 86400, "range": {"min": 1}, "raise_anomaly": true, "enable_streaming": false, "property": "sample_count", "enable_anomaly_logging": false}}, {"inputs": {"in": "Fabric Only TimeSeries"}, "type": "range_check", "name": "Check for Hypervisor missing VLAN configs", "outputs": {"out": "Hypervisor missing VLAN configs anomaly"}, "properties": {"graph_query": [], "anomaly_retention_size": 1073741824, "anomaly_retention_duration": 86400, "range": {"min": 1}, "raise_anomaly": true, "enable_streaming": false, "property": "sample_count", "enable_anomaly_logging": false}}], "stages": [{"name": "Hypervisor unique VLAN configs", "retention_duration": 86400}, {"name": "Fabric Only TimeSeries", "retention_duration": 86400}, {"name": "Hypervisor Only TimeSeries", "retention_duration": 86400}, {"name": "Fabric VLAN configs", "retention_duration": 86400}, {"name": "Hypervisor missing VLAN configs anomaly", "retention_duration": 86400}, {"name": "Hypervisor VLAN configs", "retention_duration": 86400}, {"name": "Fabric missing VLAN configs anomaly", "retention_duration": 86400}, {"name": "Common in Fabric and Hypervisor", "retention_duration": 86400}, {"name": "Hypervisor Only", "retention_duration": 86400}, {"name": "Fabric Only", "retention_duration": 86400}], "disabled": true}