{
  "label": "Fabric BGP session anomalies",
  "processors": [
    {
      "inputs": {},
      "type": "service_data_collector",
      "name": "Collect BGP session state",
      "outputs": {
        "out": "bgp_session_state"
      },
      "properties": {
        "description": "str(intf.description or 'facing %s' % (s2.hostname or s2.label or s2.role))",
        "graph_query": "match(node('system', name='s1', system_id=not_none(), deploy_mode='deploy').out('hosted_interfaces').node('interface', name='intf', if_type='ip', ipv4_addr=not_none()).out('link').node('link').in_('link').node('interface', name='other_intf', ipv4_addr=not_none()).in_('hosted_interfaces').node('system', name='s2').where(lambda s2: s2.role == 'external_router' or s2.deploy_mode == 'deploy').ensure_different('s1', 's2'), node('domain', name='d1', domain_type='autonomous_system').out('composed_of_systems').node(name='s1'), node('domain', name='d2', domain_type='autonomous_system').out('composed_of_systems').node(name='s2'))",
        "af": "'ipv4'",
        "keys": [
          "source_ip",
          "source_asn",
          "dest_ip",
          "dest_asn",
          "vrf_name",
          "af"
        ],
        "service_name": "bgp",
        "source_ip": "str(intf.ipv4_addr.split('/')[0])",
        "dest_asn": "int(d2.domain_id)",
        "vrf_name": "'default'",
        "enable_streaming": false,
        "system_id": "s1.system_id",
        "peer_hostname": "str(s2.hostname)",
        "source_asn": "int(d1.domain_id)",
        "dest_ip": "str(other_intf.ipv4_addr.split('/')[0])"
      }
    },
    {
      "inputs": {
        "in": "bgp_session_state"
      },
      "type": "state_check",
      "name": "Inactive BGP sessions",
      "outputs": {
        "out": "bgp_session_down"
      },
      "properties": {
        "graph_query": [],
        "anomaly_retention_size": 1073741824,
        "anomaly_retention_duration": 86400,
        "state": "['unknown', 'down', 'missing']",
        "raise_anomaly": true,
        "enable_streaming": false,
        "enable_anomaly_logging": false
      }
    }
  ],
  "stages": [
    {
      "name": "bgp_session_down",
      "retention_duration": 86400
    },
    {
      "name": "bgp_session_state",
      "retention_duration": 86400
    }
  ]
}