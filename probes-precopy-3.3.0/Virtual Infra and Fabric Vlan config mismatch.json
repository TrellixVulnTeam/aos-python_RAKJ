{
  "label": "Virtual Infra and Fabric Vlan config mismatch",
  "processors": [
    {
      "inputs": {},
      "type": "generic_graph_collector",
      "name": "AOS configured VLAN configs",
      "outputs": {
        "out": "AOS VLAN configs"
      },
      "properties": {
        "graph_query": "match(node('system', name='server', role='l2_server').out('hosted_interfaces').node('interface', name='server_intf').out('hosted_vn_endpoints').node('vn_endpoint', name='vn_endpoint').in_('member_endpoints').node('virtual_network').out('instantiated_by').node('vn_instance', name='vn_instance').having(node(name='vn_instance').in_('hosted_vn_instances').node('system').out('hosted_interfaces').node('interface').out('link').node('link').in_('link').node('interface').in_('hosted_interfaces').node(name='server'), at_least=1),node(name='server').in_('is_realized_by').node('hypervisor')).distinct(['server', 'vn_endpoint'])",
        "data_type": "ns",
        "vlan": "int(0 if vn_endpoint.tag_type == 'untagged' else vn_instance.vlan_id)",
        "value": "1",
        "server": "str(server.label)",
        "interface": "str(server_intf.id)",
        "traffic": "str('untagged' if vn_endpoint.tag_type == 'untagged' else 'tagged')",
        "enable_streaming": false,
        "interface_desc": "str(server_intf.description)"
      }
    },
    {
      "inputs": {},
      "type": "generic_graph_collector",
      "name": "vSphere expected VLAN configs",
      "outputs": {
        "out": "vSphere VLAN configs"
      },
      "properties": {
        "graph_query": [
          "match(node('system', name='server', system_type='server').in_('is_realized_by').node('hypervisor', name='hv').out('has').node('pnic', name='hv_nic').out('carries').node('vnet', name='vn'),node(name='hv_nic').out('is_realized_by').node('interface').in_('composed_of').node('interface', name='server_intf')).distinct(['server', 'server_intf'])",
          "match(node('system', name='server', system_type='server').in_('is_realized_by').node('hypervisor', name='hv').out('has').node('pnic', name='hv_nic').out('carries').node('vnet', name='vn'),node(name='hv_nic').out('is_realized_by').node('interface', name='server_intf').having(node(name='server_intf').in_('composed_of').node('interface'), at_most=0))"
        ],
        "data_type": "ns",
        "hypervisor": "str(hv.label)",
        "vlan": "int(vn.vlan)",
        "value": "1",
        "server": "str(server.label)",
        "interface": "str(server_intf.id)",
        "traffic": "str('tagged' if vn.vlan != 0 else 'untagged')",
        "enable_streaming": false,
        "interface_desc": "str(server_intf.description)"
      }
    },
    {
      "inputs": {
        "A": "vSphere VLAN configs",
        "B": "AOS VLAN configs"
      },
      "type": "set_comparison",
      "name": "Differences between vSphere and AOS",
      "outputs": {
        "A & B": "Common in AOS and vSphere",
        "B - A": "AOS Only",
        "A - B": "vSphere Only"
      },
      "properties": {
        "enable_streaming": false,
        "significant_keys": [
          "server",
          "vlan",
          "interface",
          "interface_desc",
          "traffic"
        ]
      }
    },
    {
      "inputs": {
        "in": "vSphere Only"
      },
      "type": "accumulate",
      "name": "AOS missing VLAN configs accumulator",
      "outputs": {
        "out": "vSphere Only TimeSeries"
      },
      "properties": {
        "enable_streaming": false,
        "max_samples": 1024,
        "graph_query": [],
        "total_duration": 0
      }
    },
    {
      "inputs": {
        "in": "AOS Only"
      },
      "type": "accumulate",
      "name": "vSphere missing VLAN configs accumulator",
      "outputs": {
        "out": "AOS Only TimeSeries"
      },
      "properties": {
        "enable_streaming": false,
        "max_samples": 1024,
        "graph_query": [],
        "total_duration": 0
      }
    },
    {
      "inputs": {
        "in": "vSphere Only TimeSeries"
      },
      "type": "range_check",
      "name": "Check for AOS missing VLAN configs",
      "outputs": {
        "out": "AOS missing VLAN configs anomaly"
      },
      "properties": {
        "graph_query": [],
        "anomaly_retention_size": 1073741824,
        "anomaly_retention_duration": 86400,
        "range": {
          "min": 1
        },
        "raise_anomaly": true,
        "enable_streaming": false,
        "property": "sample_count",
        "enable_anomaly_logging": false
      }
    },
    {
      "inputs": {
        "in": "AOS Only TimeSeries"
      },
      "type": "range_check",
      "name": "Check for vSphere missing VLAN configs",
      "outputs": {
        "out": "vSphere missing VLAN configs anomaly"
      },
      "properties": {
        "graph_query": [],
        "anomaly_retention_size": 1073741824,
        "anomaly_retention_duration": 86400,
        "range": {
          "min": 1
        },
        "raise_anomaly": true,
        "enable_streaming": false,
        "property": "sample_count",
        "enable_anomaly_logging": false
      }
    }
  ],
  "stages": [
    {
      "name": "AOS Only TimeSeries",
      "retention_duration": 86400
    },
    {
      "name": "AOS Only",
      "retention_duration": 86400
    },
    {
      "name": "vSphere missing VLAN configs anomaly",
      "retention_duration": 86400
    },
    {
      "name": "vSphere Only",
      "retention_duration": 86400
    },
    {
      "name": "Common in AOS and vSphere",
      "retention_duration": 86400
    },
    {
      "name": "AOS VLAN configs",
      "retention_duration": 86400
    },
    {
      "name": "vSphere Only TimeSeries",
      "retention_duration": 86400
    },
    {
      "name": "AOS missing VLAN configs anomaly",
      "retention_duration": 86400
    },
    {
      "name": "vSphere VLAN configs",
      "retention_duration": 86400
    }
  ]
}