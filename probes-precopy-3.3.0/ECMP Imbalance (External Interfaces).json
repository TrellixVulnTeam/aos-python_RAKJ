{
  "label": "ECMP Imbalance (External Interfaces)",
  "processors": [
    {
      "inputs": {},
      "type": "if_counter",
      "name": "external interface traffic",
      "outputs": {
        "out": "external_int_traffic"
      },
      "properties": {
        "graph_query": "node('system', name='system', deploy_mode='deploy', role=is_in(['leaf','spine']),system_id=not_none()).out('hosted_interfaces').node('interface', name='interface', if_type=is_in(['ip', 'ethernet']), if_name=not_none()).out('link').node('link', link_type='ethernet').in_('link').node('interface', if_type=is_in(['ip', 'ethernet'])).in_('hosted_interfaces').node('system', name='router', role='external_router')",
        "interface": "interface.if_name",
        "system_id": "system.system_id",
        "router": "router.label",
        "enable_streaming": false,
        "interface_desc": "interface.description or 'facing %s' % (router.hostname or router.label)",
        "counter_type": "tx_bps"
      }
    },
    {
      "inputs": {
        "in": "external_int_traffic"
      },
      "type": "std_dev",
      "name": "std-dev by router",
      "outputs": {
        "out": "ext_int_std_dev"
      },
      "properties": {
        "enable_streaming": false,
        "group_by": [
          "router"
        ],
        "ddof": 0
      }
    },
    {
      "inputs": {
        "in": "ext_int_std_dev"
      },
      "type": "range_check",
      "name": "ECMP Imbalance",
      "outputs": {
        "out": "live_ecmp_imbalance"
      },
      "properties": {
        "enable_streaming": false,
        "property": "value",
        "range": {
          "min": 3
        },
        "raise_anomaly": true,
        "graph_query": []
      }
    },
    {
      "inputs": {
        "in": "live_ecmp_imbalance"
      },
      "type": "accumulate",
      "name": "ECMP imbalance anomaly history",
      "outputs": {
        "out": "ecmp_imbalance_anomaly_history"
      },
      "properties": {
        "enable_streaming": false,
        "max_samples": 50,
        "graph_query": [],
        "total_duration": 0
      }
    }
  ],
  "stages": [
    {
      "name": "external_int_traffic",
      "units": "bps"
    }
  ]
}